# Домашнее задание к занятию "13.Системы мониторинга"

## Обязательные задания

1. Вас пригласили настроить мониторинг на проект. На онбординге вам рассказали, что проект представляет из себя платформу для вычислений с выдачей текстовых отчётов, которые сохраняются на диск. 
Взаимодействие с платформой осуществляется по протоколу http. Также вам отметили, что вычисления загружают ЦПУ. Какой минимальный набор метрик вы выведите в мониторинг и почему?


### Ответ

Важно отслеживать производительность и доступность платформы, чтобы быстро реагировать на возможные проблемы. 
Ниже представлены несколько метрик, которые я бы рекомендовал отслеживать:

- Загрузка ЦПУ: данная метрика позволяет отслеживать, насколько интенсивно используется процессор на сервере. 
Высокая загрузка ЦПУ может указывать на необходимость увеличения мощности сервера или оптимизации приложения.
- Количество запросов: данная метрика позволяет оценить количество запросов к серверу за определенный промежуток времени. 
Высокое количество запросов может указывать на популярность приложения, но также может привести к перегрузке сервера.
- Время отклика сервера: данная метрика позволяет оценить, насколько быстро сервер отвечает на запросы. 
Быстрый отклик сервера важен для удобства пользователей и оптимизации производительности приложения.
- Коды ответов сервера: данная метрика позволяет отслеживать коды ответов сервера на запросы. 
Коды ответов 2xx означают успешный запрос, а 4xx и 5xx - ошибки, которые необходимо решать.
- Использование дискового пространства: данная метрика позволяет отслеживать, сколько дискового пространства используется на сервере. 
Высокое использование дискового пространства может указывать на необходимость увеличения мощности сервера или оптимизации приложения.

Конечно, этот список метрик может быть расширен в зависимости от конкретных требований и особенностей проекта. 
Но вышеперечисленные метрики помогут понять, как происходит работа приложения и насколько оно эффективно использует ресурсы сервера.


2. Менеджер продукта, посмотрев на ваши метрики, сказал, что ему непонятно, что такое RAM/inodes/CPUla. Также он сказал, что хочет понимать, насколько мы выполняем свои обязанности перед клиентами и какое качество обслуживания. Что вы можете ему предложить?


### Ответ

Если менеджеру продукта не понятны технические термины, то можно использовать более простые и понятные метрики, которые будут отражать качество обслуживания и выполнение обязательств перед клиентами. Ниже я предлагаю несколько примеров таких метрик:

- Время отклика сервера на запросы: данная метрика отображает, сколько времени требуется серверу для ответа на запросы. Чем меньше время отклика, тем быстрее работает приложение, и тем более удобно и приятно пользоваться продуктом.
- Количество ошибок в приложении: данная метрика позволяет отслеживать количество ошибок, которые возникают в приложении. Количество ошибок может указывать на проблемы с производительностью, низкое качество кода или неправильную работу отдельных модулей приложения.
- Количество запросов на поддержку: данная метрика отображает, сколько запросов на поддержку приходит от клиентов. Чем меньше запросов на поддержку, тем меньше проблем у пользователей при работе с продуктом.
- Количество пользователей: данная метрика позволяет отслеживать количество пользователей, которые пользуются продуктом. Рост количества пользователей может указывать на популярность продукта и успешную маркетинговую стратегию.
- Количество скачиваний: данная метрика отображает, сколько раз продукт был скачан пользователем. Чем больше количество скачиваний, тем более популярен продукт.

Конечно, это не полный список метрик, но они помогут менеджеру продукта понимать, насколько успешно продукт выполняет свои обязательства перед клиентами и насколько качественно обслуживает пользователей. Важно подбирать метрики, которые наиболее отражают цели и задачи продукта.


3. Вашей DevOps-команде в этом году не выделили финансирование на построение системы сбора логов. Разработчики, в свою очередь, хотят видеть все ошибки, которые выдают их приложения. Какое решение вы можете предпринять в этой ситуации, чтобы разработчики получали ошибки приложения?

### Ответ

В данной ситуации можно использовать бесплатные инструменты для сбора логов и мониторинга приложений. Например, можно использовать сервисы, такие как Elasticsearch, Logstash, Kibana (ELK-стек), которые позволяют собирать, хранить и анализировать логи приложений.

Для реализации данного подхода можно выполнить следующие шаги:

- Установить Elasticsearch, Logstash, Kibana (ELK-стек) на одном из серверов в сети.
- Настроить логирование приложения на отправку логов в Logstash.
- Настроить Logstash на фильтрацию и парсинг логов.
- Настроить Kibana для анализа и визуализации логов.

После настройки данного стека инструментов, разработчики смогут видеть ошибки приложения в реальном времени через интерфейс Kibana. Также можно использовать уведомления, чтобы уведомлять разработчиков о новых ошибках, чтобы они могли быстро отреагировать на проблемы приложения.

Важно понимать, что бесплатные решения могут иметь ограничения по количеству хранимых логов или по производительности, поэтому при увеличении объемов логов или при росте числа пользователей приложения может потребоваться дополнительная оптимизация или переход на коммерческие инструменты.

4. Вы, как опытный SRE, сделали мониторинг, куда вывели отображения выполнения SLA = 99% по http-кодам ответов. 
Этот параметр вычисляется по формуле: summ_2xx_requests/summ_all_requests. Он не поднимается выше 70%, но при этом в вашей системе нет кодов ответа 5xx и 4xx. Где у вас ошибка?

### Ответ

Если в мониторинге нет кодов ответа 5xx и 4xx, а SLA для 2xx запросов не поднимается выше 70%, то вероятно, есть коды ответа, которые не были учтены в формуле для расчета SLA.

Следует проверить, все ли коды ответа учитываются в формуле, и возможно, есть какие-то другие коды ответа, которые не были учтены, но они влияют на общее количество запросов. Например, может быть много запросов с кодом 3xx (редирект), которые не учитываются в формуле, но они влияют на общее количество запросов.

Также возможно, что есть какие-то проблемы с сбором метрик, и не все запросы учитываются в мониторинге. В таком случае следует проверить, что все логи и метрики собираются корректно и не происходит потери данных.

В любом случае, для решения данной проблемы необходимо более детально изучить мониторинг и метрики, чтобы понять, какие данные не учитываются в расчете SLA и как это можно исправить.


5. Опишите основные плюсы и минусы pull и push систем мониторинга.

### Ответ

Pull и push системы мониторинга являются двумя основными типами мониторинга, которые используются для отслеживания состояния приложений и систем. Вот основные плюсы и минусы каждой из них:

Pull-мониторинг

Плюсы:
Высокая гибкость настройки мониторинга;
Меньшие нагрузки на сеть, так как клиенты запрашивают данные только тогда, когда это необходимо;
Большая гибкость по выбору, какие метрики и когда собирать, не все метрики должны быть получены каждую секунду.

Минусы:
Может быть затруднено определение проблемы, так как клиенты запрашивают данные только тогда, когда это необходимо;
Если клиенты запрашивают данные слишком часто, это может привести к нагрузке на мониторинговую систему.

Push-мониторинг

Плюсы:
Быстрое обнаружение проблемы, так как мониторинговая система активно отправляет данные клиентскому приложению;
Легко выявлять проблему, так как клиентское приложение получает данные без запросов.

Минусы:
Потенциальная перегрузка сети, так как данные постоянно отправляются клиентскому приложению;
Меньшая гибкость настройки мониторинга, так как мониторинговая система отправляет данные по расписанию, которое не всегда можно изменить. 

Из выбора между pull- и push-мониторингом зависит от индивидуальных требований системы мониторинга. Как правило, для больших и сложных систем рекомендуется использовать pull-мониторинг, тогда как для меньших систем, где время отклика на проблемы должно быть максимальным, рекомендуется использовать push-мониторинг.

6. Какие из ниже перечисленных систем относятся к push модели, а какие к pull? А может есть гибридные?

    - Prometheus 
    - TICK
    - Zabbix
    - VictoriaMetrics
    - Nagios

### Ответ

Prometheus и VictoriaMetrics относятся к push-модели мониторинга, в которой экспортеры (agents) отправляют метрики на сервер мониторинга.

TICK и Zabbix могут работать как в режиме push, так и в режиме pull, в зависимости от настроек. В режиме push, агенты отправляют метрики на сервер мониторинга, а в режиме pull, сервер мониторинга запрашивает метрики у агентов.

Nagios относится к pull-модели мониторинга, в которой сервер мониторинга запрашивает метрики у агентов.

Таким образом, TICK и Zabbix являются гибридными системами, которые могут работать как в режиме push, так и в режиме pull.

3. Склонируйте себе [репозиторий](https://github.com/influxdata/sandbox/tree/master) и запустите TICK-стэк, 
используя технологии docker и docker-compose.

В виде решения на это упражнение приведите выводы команд с вашего компьютера (виртуальной машины):

    - curl http://localhost:8086/ping
    - curl http://localhost:8888
    - curl http://localhost:9092/kapacitor/v1/ping

А также скриншот веб-интерфейса ПО chronograf (`http://localhost:8888`). 

P.S.: если при запуске некоторые контейнеры будут падать с ошибкой - проставьте им режим `Z`, например
`./data:/var/lib:Z`
#
4. Перейдите в веб-интерфейс Chronograf (`http://localhost:8888`) и откройте вкладку `Data explorer`.

    - Нажмите на кнопку `Add a query`
    - Изучите вывод интерфейса и выберите БД `telegraf.autogen`
    - В `measurments` выберите mem->host->telegraf_container_id , а в `fields` выберите used_percent. 
    Внизу появится график утилизации оперативной памяти в контейнере telegraf.
    - Вверху вы можете увидеть запрос, аналогичный SQL-синтаксису. 
    Поэкспериментируйте с запросом, попробуйте изменить группировку и интервал наблюдений.

Для выполнения задания приведите скриншот с отображением метрик утилизации места на диске 
(disk->host->telegraf_container_id) из веб-интерфейса.
#
5. Изучите список [telegraf inputs](https://github.com/influxdata/telegraf/tree/master/plugins/inputs). 
Добавьте в конфигурацию telegraf следующий плагин - [docker](https://github.com/influxdata/telegraf/tree/master/plugins/inputs/docker):
```
[[inputs.docker]]
  endpoint = "unix:///var/run/docker.sock"
```

Дополнительно вам может потребоваться донастройка контейнера telegraf в `docker-compose.yml` дополнительного volume и 
режима privileged:
```
  telegraf:
    image: telegraf:1.4.0
    privileged: true
    volumes:
      - ./etc/telegraf.conf:/etc/telegraf/telegraf.conf:Z
      - /var/run/docker.sock:/var/run/docker.sock:Z
    links:
      - influxdb
    ports:
      - "8092:8092/udp"
      - "8094:8094"
      - "8125:8125/udp"
```

После настройке перезапустите telegraf, обновите веб интерфейс и приведите скриншотом список `measurments` в 
веб-интерфейсе базы telegraf.autogen . Там должны появиться метрики, связанные с docker.

Факультативно можете изучить какие метрики собирает telegraf после выполнения данного задания.

---
